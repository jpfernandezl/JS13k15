/** Initializations **/

// Debug
_ = function(a){ console.log(a) }

// Names of places, capitols, us capitols, countries, us states, in one string (0: category separator, 1: difficulty separator)
g = "Cape canaveralChrist the redeemerThe great chinese wallThe great sphinxThe eiffel towerTower of pisaMount everestSagrada familiaBig benThe statue of libertyForbidden cityThe pyramids of gizaThe palace of versaillesAcropolisTrevi fountainKremlinLoch nessAtomiumLascaux cavesMont st. michelPiazza san marcoThe grand canyonMillau bridgeRock of gibraltarThe empire state buildingHollywood signTimes squareLouvre museumWhite houseFlorence cathedralLas vegasMadrid palaceCentral parkSistine chapelPiazza del campo1Machu picchuThe burj al arab hotelSt. peter's cathedralKilimanjaroCapitol hillLuxor templeGolden gate bridgeBurj khalifaAlcatrazEphesusManneken pisMount eden craterNorth capeSt. basil's cathedralVictoria fallsThe great buddhaLotus templeThe colosseumAbu simbelPetronas twin towersYellowstoneNiagara fallsThe taj mahalMount fujiMeccaAuschwitzStonehengeMount rushmorePentagonCape of good hopeOpera houseParc guellPompeiiDead sea1WaterlooEaster islandEvergladesCloud gateRialto bridgeWillis towerLittle mermaidTower bridgeThe blue mosqueNevado mismiTable mountainMinaret of jamAngkor watFaisal mosqueNeuschwanstein castleGolden temple of amritsarAl aqsa mosqueTemple of besakihChichen itzaBran castleHagia sophiaUluruBrandenburg gateBlue domed churchTaal lakeCheyenne mountainKiyomizu-deraPetraTombouctouKultury i nauki palace0AlgiersBuenos airesCanberraViennaBrusselsBrasiliaSofiaOttawaSantiagoBeijingZagrebHavanaPragueCopenhagenQuitoCairoTallinnHelsinkiParisBerlinAthensBudapestReykjavikNew delhiJakartaTehranBaghdadDublinJerusalemRomeKingstonTokyoBeirutVilniusLuxembourgSkopjeAntananarivoMexico cityMonacoRabatKathmanduAmsterdamWellingtonPyongyangOsloRamallahAsunciónLimaManilaWarsawLisbonBucharestDohaMoscowRiyadhSingaporeBratislavaLjubljanaPretoriaSeoulMadridStockholmBernTaipeiTunisAnkaraKyivMontevideoAbu dhabiLondonWashington d.c.CaracasVatican cityHanoiGeorgetownTripoli1KabulAndorra la vellaTiranaMinskSarajevoOuagadougouYaoundéBanguiBrazzavilleKinshasaYamoussoukroSan joseBogotáLa pazPraiaNicosiaPorto-novoPhnom penhRoseauSanto domingoMalaboGuatemala cityPort-au-princeTegucigalpaAmmanAstanaPristinaKuwait cityVientianeNairobiKuala lumpurBamakoVallettaChisinauIslamabadPanama citySan marinoDakarBelgradeVictoriaMogadishuSri jayawardenepura kotteKhartoumDodomaBangkokSana'aHarare1Saint john'sYerevanBakuLuandaNassauManamaDhakaBridgetownBelmopanThimphuGaboroneBandar seri begawanBujumburaN'djamenaMoroniDjiboutiSan salvadorAsmaraAddis ababaSuvaLibrevilleBanjulTbilisiAccraSt. george'sConakryBissauSouth tarawaBishkekRigaMaseruMonroviaVaduzLilongweMaleMajuroNouakchottPort louisPalikirUlaanbaatarPodgoricaMaputoNaypyidawWindhoekYaren districtManaguaNiameyAbujaMuscatNgerulmudPort moresbyKigaliBasseterreCastriesKingstownApiaSão toméFreetownHoniaraJubaParamariboMbabaneDamascusDushanbeDiliLoméNuku'alofaPort of spainAshgabatFunafutiKampalaTashkentPort vilaLusaka0HonoluluJuneauOlympiaCarson citySanta feAlbanyTallahasseeSpringfieldColumbusProvidenceColumbiaAustinSalt lake cityRichmondCharlestonHarrisburgBostonRaleighMontgomerySacramentoDenverAtlantaLansing1BismarckHelenaLincolnPhoenixLittle rockConcordTrentonHartfordDoverOklahoma cityBoiseSalemIndianapolisDes moinesTopekaPierreFrankfortNashvilleBaton rougeAugustaAnnapolisMontpelierSt. paulJacksonMadisonJefferson cityCheyenne0AlgeriaArgentinaAustraliaAustriaBelgiumBrazilBulgariaCanadaChileChinaCroatiaCubaCzech republicDenmarkEcuadorEgyptEstoniaFinlandFranceGermanyGreeceHungaryIcelandIndiaIndonesiaIranIraqIrelandIsraelItalyJamaicaJapanLebanonLithuaniaLuxembourgMacedoniaMadagascarMexicoMonacoMoroccoNepalNetherlandsNew zealandNorth koreaNorwayPalestineParaguayPeruPhilippinesPolandPortugalRomaniaQatarRussiaSaudi arabiaSingaporeSlovakiaSloveniaSouth africaSouth koreaSpainSwedenSwitzerlandTaiwanTunisiaTurkeyUkraineUruguayUnited arab emiratesUnited kingdomU.s.a.VenezuelaVatican cityVietnamGuyanaLibya1AfghanistanAndorraAlbaniaBelarusBosnia and herzegovina Burkina fasoCameroonCentral african republicRepublic of the congo Democratic republic of the congo Cote d'ivoireCosta ricaColombiaBoliviaCabo verdeCyprusBeninCambodiaDominicaDominican republicEquatorial guineaGuatemalaHaitiHondurasJordanKazakhstanKosovoKuwaitLaosKenyaMalaysiaMaliMaltaMoldovaPakistanPanamaSan marinoSenegalSerbiaSeychellesSomaliaSri lankaSudanTanzaniaThailandYemenZimbabwe1Antigua and barbudaArmeniaAzerbaijanAngolaBahamasBahrainBangladeshBarbadosBelizeBhutanBotswanaBruneiBurundiChadComorosDjiboutiEl salvadorEritreaEthiopiaFijiGabonGambiaGeorgiaGhanaGrenadaGuineaGuinea-bissauKiribatiKyrgyzstanLatviaLesothoLiberiaLiechtensteinMalawiMaldivesMarshall islandsMauritaniaMauritiusMicronesiaMongoliaMontenegroMozambiqueMyanmarNamibiaNauruNicaraguaNigerNigeriaOmanPalauPapua new guineaRwandaSaint kitts and nevisSaint luciaSaint vincent and the grenadinesSamoaSao tome and principeSierra leoneSolomon islandsSouth sudanSurinameSwazilandSyriaTajikistanTimor-lesteTogoTongaTrinidad and tobagoTurkmenistanTuvaluUgandaUzbekistanVanuatuZambia1GreenlandWestern sahara0HawaiiAlaskaWashingtonNevadaNew mexicoNew yorkFloridaIllinoisOhioRhode islandSouth carolinaTexasUtahVirginiaWest virginiaPennsylvaniaMassachusettsNorth carolinaAlabamaCaliforniaColoradoGeorgiaMichigan1North dakotaMontanaNebraskaArizonaArkansasNew hampshireNew jerseyConnecticutDelawareOklahomaIdahoOregonIndianaIowaKansasSouth dakotaKentuckyTennesseeLouisianaMaineMarylandVermontMinnesotaMississippiWisconsinMissouriWyoming".split(0);

// Context2d
h = $.getContext("2d");

// Math
m = Math;

// Game state
n = 0;

// Stars position and size
s = []; for(i = 0; i < 300; i++) s[i] = [m.random() * 1200, m.random() * 650, m.random() + .5];

// Text
t = function(x, y, text, size, color, align){
    size = size || 50;
    color = color || "#fff";
    align = align || "center";
    h.textAlign = align;
    h.fillStyle = color;
    h.font = size + "px Impact, Charcoal";
    h.fillText(text, x, y);
}

// Stars scroll offset
u = 0;

// Earth rotation offset
v = 0;

// Current level / puzzle
A = 0;
B = 0;

/** Gather & shuffle the data **/

// Load the game's data in AJAX, as an arrayBuffer, from the file called "1"
a = new XMLHttpRequest;
a.open("GET", 1);
a.responseType = 'arraybuffer';
a.send();
a.onload = function(){
    
    b = new Uint8Array(a.response);
    
    c = 0;
    
    // Reconstitute all the data
    // For each category
    for(i in g){
        g[i] = g[i].split(1);
        
        // For each difficulty
        for(j in g[i]){
            g[i][j] = g[i][j].split(/(?=[A-Z])/);
            
            // For each name
            for(k in g[i][j]){
                
                // Make an array with the name and the coordinates
                // 2 coordinates for places, capitols, us capitols
                if(i < 3){
                    g[i][j][k] = [g[i][j][k], [b[c], b[c+1]]];
                    c += 2;
                }
                
                // List of coordinates separated by 254 for countries and us states
                else{
                    g[i][j][k] = [g[i][j][k], []];
                    while(b[c]!= 254 && c < b.length){
                        g[i][j][k][1].push(b[c]);
                        c++;
                    }
                    c++;
                }
            }
        }
    }
    
    // Shuffle
    b = function(){return .5 - m.random()}
    g[0][0].sort(b); // Places easy
    g[0][1].sort(b); // Places medium
    g[0][2].sort(b); // Places hard
    g[1][0].sort(b); // Capitols easy
    g[1][1].sort(b); // Capitols medium
    g[1][2].sort(b); // Capitols hard
    g[2][0].sort(b); // US capitols easy
    g[2][1].sort(b); // US capitols hard
    g[3][0].sort(b); // Countries easy
    g[3][1].sort(b); // Countries medium
    g[3][2].sort(b); // Countries hard
    g[4][0].sort(b); // US states easy
    g[4][1].sort(b); // US states hard
    
    // Launch game
    setInterval(w, 33);
}
    
/** Game loop **/
w = function(){
    
    // Reset canvas
    $.width ^= 0;
    
    
    // Welcome screen
    if(n == 0){
        
        // Stars
        u--;
        u %= 1200;

        for(i = 0; i < 300; i++){
          h.fillStyle = "#fff";
          h.beginPath();
          h.arc(a = s[i][0] + u, b = s[i][1], c = s[i][2] + m.random() * .2, 0, 7);
          h.arc(1200 + a, b, c, 0, 7);
          h.fill();
        }

        // Earth

        // Background
        h.beginPath();
        gradient = h.createLinearGradient(300,0,600,0);
        gradient.addColorStop(0,"#75D1FF");
        gradient.addColorStop(1,"#3591bF");
        h.fillStyle = gradient;
        h.arc(470, 260, 140, 0, 7);
        h.fill();
        
        // Rotation
        v += 1;
        v %= 220;
        
        // Countries
        h.strokeStyle = "#83864F";
        h.fillStyle = "#95D866";
        
        // Loop on difficulties
        for(i = 0; i < g[3].length; i++){
            
            // Loop on countries
            for(j = 0; j < g[3][i].length; j++){
                
                // Current country
                a = g[3][i][j][1];
                
                // Loop on coordinates
                for(k = 0; k < a.length; k += 2){
                    
                    // Start new island
                    if(a[k] == 255){
                        k++;
                        h.closePath();
                        h.fill();
                        h.stroke();
                        h.beginPath();
                    }
                    
                    //tmp
                    if(a[k+1]==255){
                        k+=2;
                        h.closePath();
                        h.fill();
                        h.stroke();
                        h.beginPath();
                    }

                    // Current point
                    x = (a[k] - v) / 110;
                    y = (a[k+1] - 120) / 150;
                    
                    while(x > 1) x-=2;
                    if(x > -1 && x < -.5) x = -0.5;
                    if(x > .5 && x < 1) x = 0.5;
                    
                    // Fix canada & russia
                    if(!k && g[3][i][j][0] != "Russia" && g[3][i][j][0] != "Canada"){
                        if(x < 0) b = -.5;
                        else b = .5;
                    }
                    
                    if(g[3][i][j][0] == "Russia"){
                        b = -.5;
                        if(v > 70) b = .5;
                        if(v > 170) b = -.5;
                    }
                    
                    if(g[3][i][j][0] == "Canada"){
                        b = .5;
                        if(v > 40) b = -.5;
                        if(v > 140) b = .5;
                    }
                    
                    if((x <= -.5 || x >= .5)) x = b;
                    
                    x = m.sin(x * m.PI) * m.cos(y * m.PI / 2);
                    y = m.sin(y * m.PI / 2);
                    x = x * 140 + 470;
                    y = y * 140 + 260;
                    
                    // Start country
                    if(k == 0){
                        h.beginPath();
                        h.moveTo(x, y);
                    }
                    
                    // Continue country
                    h.lineTo(x, y);
                }
                
                h.closePath();
                h.fill();
                h.stroke();
            }
        }

        // Text
        t(180, 375, "GE", 300);
        t(890, 375, "Quiz", 300);
        t(990, 405, "JS13kGames 2015", 30);
        t(600, 570, "START", 80);
    }
    
    // Level presentation screen
    else if(n==1){
        
        t(600, 280, "Level " + (A + 1) + ":", 60);
        
        t(600,  360, [
        "Countries (easy)",
        "Capitols (easy)",
        "Famous places (easy)",
        "Countries (medium)",
        "Capitols (medium)",
        "U.S. states (medium)",
        "Famous places (medium)",
        "U.S. capitols (medium)",
        "World countries (hard)",
        "U.S. states (hard)",
        "Famous places (hard)",
        "U.S. capitols (hard)",
        "Capitols (hard)"
        ][A], 60);
    }
}


/** Handle Clicks **/
$.onclick = function(a){
    
    // Home screen
    if(n == 0){
        n = 1;
    }
    
    // Level presentation screen
    else if(n == 1){
        n = 2;
        o = 300;
    }
    
    // Puzzle screen
    else if(n == 2){
        X = a.pageX;
        Y = a.pageY;
    }
}